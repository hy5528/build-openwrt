name: build onecloud-25.02

on:
  repository_dispatch:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

      
    steps:
      - name: é‡Šæ”¾ç£ç›˜ç©ºé—´
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
          
    
      - name: Checkout armbian
        run: |
           git clone --depth=1 --branch=main https://github.com/soulteary/armbian-build-s805.git build 

           CORE_DATE=$(TZ=Asia/Shanghai date +"%y.%m.%d")
           CORE_TAG="ç©å®¢äº‘armbian_"
           show_tag_name=${CORE_TAG}${CORE_DATE}
           echo "show_tag_name=$show_tag_name" >> $GITHUB_ENV
           
      - name: "Checkout current repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          clean: false
          path: current
          
      - name: "Copy userpatches to build folder"
        shell: bash
        run: |
          sudo rm -r build/lib     
          rsync -av current/patch/. build/
          sudo chmod 777 build/compile.sh
     
          
      - name: Build
        run: |
          cd build
          # Don't update remote cache
          sudo ./compile.sh BOARD=onecloud BRANCH=current RELEASE=bookworm BUILD_MINIMAL=no BUILD_DESKTOP=no KERNEL_ONLY=no KERNEL_CONFIGURE=no COMPRESS_OUTPUTIMAGE=sha,gpg,img DOWNLOAD_MIRROR=china MAINLINE_MIRROR=tuna EXTRAWIFI=no
          sudo chown $(id -u):$(id -g) -R output/

      - name: å®‰è£…ä¾èµ–é¡¹
        run: |
          sudo apt install android-sdk-libsparse-utils
          ver="v0.3.2"
          curl -L -o ./AmlImg https://github.com/rmoyulong/AmlImg/releases/download/$ver/AmlImg_${ver}_linux_amd64
          chmod +x ./AmlImg

      - name: ä¸‹è½½å¹¶è§£å‹æœ€æ–°çš„ u-boot
        run: |
          echo "::group::Download"
          curl -L -o ./uboot.img https://github.com/rmoyulong/u-boot-onecloud/releases/download/Onecloud_Uboot_23.12.24_18.15.09/eMMC.burn.img
          echo "::endgroup::"
          
          echo "::group::Unpack"
          ./AmlImg unpack ./uboot.img burn/
          echo "::endgroup::"

      - name: æå–bootå’Œrootfsåˆ†åŒº
        run: |
          diskimg=$(ls build/output/images/*.img)
          loop=$(sudo losetup --find --show --partscan $diskimg)
          sudo img2simg ${loop}p1 burn/boot.simg
          sudo img2simg ${loop}p2 burn/rootfs.simg
          sudo losetup -d $loop
          sudo chown $(id -u):$(id -g) -R burn/

      - name: ç”Ÿæˆåˆ»å½•æ˜ åƒ
        run: |
          echo -n "sha1sum $(sha1sum burn/boot.simg | awk '{print $1}')" >burn/boot.VERIFY
          echo -n "sha1sum $(sha1sum burn/rootfs.simg | awk '{print $1}')" >burn/rootfs.VERIFY
          
          cat <<EOF >>burn/commands.txt
          PARTITION:boot:sparse:boot.simg
          VERIFY:boot:normal:boot.VERIFY
          PARTITION:rootfs:sparse:rootfs.simg
          VERIFY:rootfs:normal:rootfs.VERIFY
          EOF
          
          prefix=$(ls build/output/images/*.img | sed 's/\.img$//')
          burnimg=${prefix}.burn.img
          ./AmlImg pack $burnimg burn/

      - name: è¿›è¡Œå“ˆå¸Œå¤„ç†å’Œå‹ç¼©
        run: |
          for f in build/output/images/*.img; do
            sha256sum "$f" | tee -a sha256sum
            xz --threads=0 --compress "$f"
          done

      - name: ç”Ÿæˆå‘å¸ƒä¿¡æ¯
        run: |
          cat <<EOF | sed -E 's/^  //' | tee Release.md
            $(cat sha256sum | awk '{printf "%s: `%s`\n", $2, $1}')
          EOF

      - name: æå–ç‰ˆæœ¬å·
        run: |  
          # æå–ç‰ˆæœ¬å·
          # latest_image=$(ls ${{ github.workspace }}/build/output/images/Armbian-unofficial_*.img.xz | grep -oE 'Armbian-unofficial_[0-9.]+_.*' | sort -V | tail -n 1) 
          latest_image=$(ls ${{ github.workspace }}/build/output/images/Armbian-unofficial_*.img.xz | sort -V | tail -n 1)
          version=$(echo "$latest_image" | cut -d'_' -f2)  
  
          # å°†ç‰ˆæœ¬å·è®¾ç½®ä¸ºç¯å¢ƒå˜é‡  
          echo "VERSION=$version" >> $GITHUB_ENV
          
      - name: ç”Ÿæˆæ ‡ç­¾ï¼Œä¸Šä¼ å›ºä»¶
        uses: ncipollo/release-action@main
        with:
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{env.show_tag_name}}
          artifacts: build/output/images/*
          removeArtifacts: false 
          replacesArtifacts: true          
          body: | 
            ====================ğŸ§Šå›ºä»¶ä¿¡æ¯ğŸ§Š=======================
            â¦ ğŸ’» å›ºä»¶æºç ï¼šhttps://github.com/armbian/build
            â¦ ğŸ’ æºç åˆ†æ”¯ï¼š${{ github.event.inputs.BRANCH_TYPE }}
            â¦ ğŸš€ ç¼–è¯‘ç‰ˆæœ¬ï¼š${{ env.version }}
            â¦ ğŸŒ é»˜è®¤ç”¨æˆ·ï¼šroot
            â¦ ğŸ”‘ é»˜è®¤å¯†ç ï¼š1234
